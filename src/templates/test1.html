<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Emissions Report</title>

   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


   <style>
       body {
           font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
           background-color: #F5F5F5;
           color: #333;
           margin: 0;
           padding: 0;
       }


       .container {
           max-width: 1200px;
           margin: 20px auto;
           background-color: white;
           padding: 20px;
           border-radius: 10px;
           box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
       }


       table, th, td {
           border: 1px solid black;
           border-collapse: collapse;
           padding: 8px;
           text-align: center;
       }


       th {
           background-color: #063800;
           color: white;
       }


       .submit-button {
           background-color: #063800;
           color: white;
           padding: 10px 20px;
           border: none;
           border-radius: 4px;
           font-size: 16px;
           cursor: pointer;
       }


       .submit-button:hover {
           background-color: #1E6B47;
       }


       .tab-content {
           margin-top: 20px;
       }


       .nav-tabs .nav-link {
           background-color: #063800;
           color: white;
           border: none;
       }


       .nav-tabs .nav-link.active {
           background-color: #045000;
       }


       .chart-container {
           width: 100%;
           max-width: 800px;
           margin: 20px auto;
       }
   </style>
</head>
<body>


<div class="container">
   <h1 class="text-center">Emissions Report</h1>


   <!-- Form to enter company name -->
   <form method="post" class="mb-4">
       <label for="company_name" class="form-label">Enter Company Identifier:</label>
       <input type="text" id="company_name" name="company_name" class="form-control" required>


       <div class="form-check mt-2">
           <input class="form-check-input" type="radio" id="company" name="idType" value="name" checked>
           <label class="form-check-label" for="company">Company</label>
       </div>
       <div class="form-check">
           <input class="form-check-input" type="radio" id="ticker" name="idType" value="ticker">
           <label class="form-check-label" for="ticker">Ticker</label>
       </div>
       <div class="form-check">
           <input class="form-check-input" type="radio" id="isin" name="idType" value="isin">
           <label class="form-check-label" for="isin">ISIN</label>
       </div>


       <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px;">
           <button type="submit" id="submit" class="submit-button">Search</button>
       </div>
   </form>


   {% if company_name %}
   <ul class="nav nav-tabs" id="resultTabs" role="tablist">
       <li class="nav-item">
           <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-content">Extracted Table</button>
       </li>
       <li class="nav-item">
           <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart-content">Data Visualization</button>
       </li>
   </ul>


   <div class="tab-content">
       <!-- Table Section -->
       <div class="tab-pane fade show active" id="table-content">
           {% if table_html %}
               <div id="emissionsDataContainer">
                   {{ table_html | safe }}
               </div>
           {% else %}
               <p>No table data available.</p>
           {% endif %}
       </div>


       <!-- Histogram Visualization Section -->
       <div class="tab-pane fade" id="chart-content">
           <div class="chart-container">
               <h3>Emissions Data Visualization</h3>
               <canvas id="emissionsChart"></canvas>
           </div>
       </div>
   </div>
   {% endif %}
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
document.addEventListener("DOMContentLoaded", function () {
   function extractDataFromTable() {
       const table = document.querySelector("#emissionsDataContainer table");
       if (!table) {
           console.error("No table found!");
           return;
       }


       const rows = table.querySelectorAll("tr");
       if (rows.length < 2) {
           console.error("Table has no data rows.");
           return;
       }


       // === Step 1: Extract Headers & Keep Only Year Columns ===
       const headers = Array.from(rows[0].querySelectorAll("th")).map(th => th.innerText.trim());


       let yearHeaders = headers.filter(h => /^\d{4}$/.test(h));
       let yearIndexes = headers.map((h, i) => (yearHeaders.includes(h) ? i : -1)).filter(i => i !== -1);


       if (yearHeaders.length === 0) {
           console.error("No valid year columns found.");
           return;
       }


       console.log("✅ Extracted Year Headers:", yearHeaders);


       let emissionsData = {};
       let dataFound = false;


       rows.forEach((row, rowIndex) => {
           if (rowIndex === 0) return;


           const cells = row.querySelectorAll("td");
           let metricName = `Metric ${rowIndex}`;
           let values = yearIndexes.map(colIndex => {
               let value = parseFloat(cells[colIndex]?.innerText.replace(/,/g, "").trim()) || 0;
               if (value !== 0) dataFound = true;
               return value;
           });


           emissionsData[metricName] = values;
       });


       if (dataFound) {
           setTimeout(() => renderHistogram(yearHeaders, emissionsData), 500);
       } else {
           console.warn("⚠️ No valid emissions data found.");
       }
   }


   function renderHistogram(labels, emissionsData) {
       const canvas = document.getElementById("emissionsChart");
       if (!canvas) {
           console.error("No canvas element found!");
           return;
       }


       const ctx = canvas.getContext("2d");


       if (window.myChart) {
           window.myChart.destroy();
       }


       const datasets = Object.keys(emissionsData).map((metric, index) => ({
           label: metric,
           data: emissionsData[metric],
           backgroundColor: getRandomColor(index),
           borderWidth: 1
       }));


       window.myChart = new Chart(ctx, {
           type: "bar",
           data: { labels: labels, datasets: datasets },
           options: {
               responsive: true,
               plugins: {
                   legend: { position: "top" },
                   title: { display: true, text: "Emissions Over the Years" }
               },
               scales: {
                   x: { title: { display: true, text: "Year" } },
                   y: { title: { display: true, text: "Emissions" }, beginAtZero: true }
               }
           }
       });
   }


   function getRandomColor(index) {
       const colors = ["rgba(255, 99, 132, 0.7)", "rgba(54, 162, 235, 0.7)", "rgba(255, 206, 86, 0.7)"];
       return colors[index % colors.length];
   }


   extractDataFromTable();
});
</script>


</body>
</html>



